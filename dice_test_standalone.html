<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Test - Standalone</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            overflow: hidden;
        }
        #game-canvas {
            display: block;
        }
    </style>
</head>
<body>
    <canvas id="game-canvas"></canvas>

    <!-- Minimal setup for dice test -->
    <script>
        // Minimal Input module
        const Input = {
            keys: {},
            mouse: { x: 0, y: 0, clicked: false, justClicked: false, justReleased: false, button: 0, wheelDelta: 0 },
            drag: { active: false },
            init() {
                window.addEventListener('mousemove', (e) => {
                    this.mouse.x = e.clientX;
                    this.mouse.y = e.clientY;
                });
                window.addEventListener('mousedown', (e) => {
                    this.mouse.clicked = true;
                    this.mouse.justClicked = true;
                    this.mouse.button = e.button;
                    
                    // Prevent context menu on right click
                    if (e.button === 2) {
                        e.preventDefault();
                    }
                });
                window.addEventListener('mouseup', (e) => {
                    this.mouse.clicked = false;
                    this.mouse.justReleased = true;
                });
                window.addEventListener('wheel', (e) => {
                    this.mouse.wheelDelta = e.deltaY;
                    e.preventDefault();
                }, { passive: false });
                // Prevent context menu
                window.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                console.log('Input initialized');
            },
            getMousePosition() {
                return { x: this.mouse.x, y: this.mouse.y };
            },
            reset() {
                this.mouse.justClicked = false;
                this.mouse.justReleased = false;
                this.mouse.wheelDelta = 0;
            }
        };

        // Minimal Renderer module
        const Renderer = {
            canvas: null,
            ctx: null,
            init(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                console.log('Renderer initialized:', this.canvas.width, 'x', this.canvas.height);
            }
        };
    </script>

    <!-- Load dice modules -->
    <script src="src/components/button.js"></script>
    <script src="src/components/panel.js"></script>
    <script src="src/components/character_panel.js"></script>
    <script src="src/ship_data.js"></script>
    <script src="src/captain_data.js"></script>
    <script src="src/crew_data.js"></script>
    <script src="src/dice_data.js"></script>
    <script src="src/dice_abilities.js"></script>
    <script src="src/dice_icons.js"></script>
    <script src="src/die.js"></script>
    <script src="assets/sounds/volume_config.js"></script>
    <script src="src/audio.js"></script>
    <script src="src/particles.js"></script>
    <script src="src/status_effects.js"></script>
    <script src="src/combat_effects.js"></script>
    <script src="src/combat.js"></script>
    <script src="src/combat_manager.js"></script>
    
    <!-- Combat UI Elements -->
    <script src="src/elements/tooltip.js"></script>
    <script src="src/elements/rolling_box.js"></script>
    <script src="src/elements/expanded_ability_panel.js"></script>
    <script src="src/elements/expanded_unit_panel.js"></script>
    <script src="src/elements/reroll_modal.js"></script>
    <script src="src/elements/unit_selection_dialog.js"></script>
    <script src="src/elements/unit_info_card.js"></script>
    <script src="src/elements/combat_log.js"></script>
    <script src="src/elements/reroll_tray.js"></script>
    <script src="src/elements/combat_buttons.js"></script>
    
    <script src="src/ui_combat.js"></script>
    <script src="src/dice_system.js"></script>
    <script src="src/dice_test_bootstrap.js"></script>

    <script>
        console.log('=== Starting Dice Test ===');
        
        // Initialize Audio first (needed for combat effects)
        Audio.init();
        
        // Load combat sounds
        async function loadCombatSounds() {
            const soundNames = ['combat_thud', 'combat_slice', 'combat_heal', 'combat_powerup', 'combat_twinkle'];
            const AudioElement = window.Audio; // Use browser's Audio constructor
            
            for (const soundName of soundNames) {
                Audio.sounds[soundName] = await new Promise((resolve, reject) => {
                    const audio = new AudioElement(`assets/sounds/${soundName}.mp3`);
                    audio.preload = 'auto';
                    
                    const onLoad = () => {
                        console.log(`Loaded ${soundName}`);
                        audio.removeEventListener('canplaythrough', onLoad);
                        audio.removeEventListener('error', onError);
                        resolve(audio);
                    };
                    
                    const onError = (e) => {
                        console.error(`Failed to load ${soundName}:`, e);
                        audio.removeEventListener('canplaythrough', onLoad);
                        audio.removeEventListener('error', onError);
                        reject(e);
                    };
                    
                    audio.addEventListener('canplaythrough', onLoad);
                    audio.addEventListener('error', onError);
                    
                    // Trigger load
                    audio.load();
                });
            }
            
            console.log('All combat sounds loaded:', Object.keys(Audio.sounds));
        }
        
        // Initialize
        Renderer.init('game-canvas');
        Input.init();
        
        // Load sounds and then initialize dice system
        loadCombatSounds().then(() => {
            console.log('DiceSystem:', DiceSystem);
            DiceSystem.init();
            
            // Game loop
            let lastFrameTime = 0;
            function gameLoop(currentTime) {
                const deltaTime = lastFrameTime ? (currentTime - lastFrameTime) / 1000 : 0;
                lastFrameTime = currentTime;
                
                // Update
                DiceSystem.update(deltaTime);
                
                // Handle input
                const mousePos = Input.getMousePosition();
                if (mousePos) {
                    // Mouse down
                    if (Input.mouse.justClicked) {
                        DiceSystem.onMouseDown(mousePos, Renderer.canvas);
                    }
                    
                    // Mouse up
                    if (Input.mouse.justReleased) {
                        DiceSystem.onMouseUp(mousePos, Renderer.canvas);
                    }
                    
                    // Mouse wheel
                    if (Input.mouse.wheelDelta !== 0) {
                        DiceSystem.onMouseWheel(Input.mouse.wheelDelta, mousePos, Renderer.canvas);
                    }
                    
                    // Mouse move
                    DiceSystem.onMouseMove(mousePos, Renderer.canvas);
                }
                
                // Render
                DiceSystem.render(Renderer.ctx, Renderer.canvas);
                
                // Reset input
                Input.reset();
                
                requestAnimationFrame(gameLoop);
            }
            
            console.log('Starting game loop...');
            requestAnimationFrame(gameLoop);
        }).catch(error => {
            console.error('Failed to load combat sounds:', error);
            // Continue anyway
            console.log('DiceSystem:', DiceSystem);
            DiceSystem.init();
            
            // Game loop
            let lastFrameTime = 0;
            function gameLoop(currentTime) {
                const deltaTime = lastFrameTime ? (currentTime - lastFrameTime) / 1000 : 0;
                lastFrameTime = currentTime;
                
                // Update
                DiceSystem.update(deltaTime);
                
                // Handle input
                const mousePos = Input.getMousePosition();
                if (mousePos) {
                    // Mouse down
                    if (Input.mouse.justClicked) {
                        DiceSystem.onMouseDown(mousePos, Renderer.canvas);
                    }
                    
                    // Mouse up
                    if (Input.mouse.justReleased) {
                        DiceSystem.onMouseUp(mousePos, Renderer.canvas);
                    }
                    
                    // Mouse wheel
                    if (Input.mouse.wheelDelta !== 0) {
                        DiceSystem.onMouseWheel(Input.mouse.wheelDelta, mousePos, Renderer.canvas);
                    }
                    
                    // Mouse move
                    DiceSystem.onMouseMove(mousePos, Renderer.canvas);
                }
                
                // Render
                DiceSystem.render(Renderer.ctx, Renderer.canvas);
                
                // Reset input
                Input.reset();
                
                requestAnimationFrame(gameLoop);
            }
            
            console.log('Starting game loop...');
            requestAnimationFrame(gameLoop);
        });
    </script>
</body>
</html>

